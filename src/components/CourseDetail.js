// src/components/CourseDetail.js
import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { getAllCourses, updateCourse, deleteCourse } from '../utils/storage';
import { generateSingleCoursePDF } from '../utils/pdfExport';
import './CourseDetail.css';
import ProgressTracker from './ProgressTracker';

const CourseDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [course, setCourse] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState({});
  const descriptionRef = useRef(null);

  useEffect(() => {
    const courses = getAllCourses();
    const foundCourse = courses.find(c => c.id === parseInt(id));
    if (foundCourse) {
      setCourse(foundCourse);
      setEditForm(foundCourse);
    } else {
      navigate('/');
    }
  }, [id, navigate]);

  const handleEdit = () => {
    setIsEditing(true);
    // Attendre que le DOM soit mis √† jour
    setTimeout(() => {
      if (descriptionRef.current) {
        descriptionRef.current.innerHTML = editForm.description || '';
      }
    }, 0);
  };

  const handleSave = () => {
    // R√©cup√©rer le contenu HTML de l'√©diteur
    const descriptionContent = descriptionRef.current ? descriptionRef.current.innerHTML : editForm.description;
    
    const updatedForm = {
      ...editForm,
      description: descriptionContent
    };

    const updatedCourse = updateCourse(parseInt(id), updatedForm);
    if (updatedCourse) {
      setCourse(updatedCourse);
      setIsEditing(false);
    }
  };

  const handleCancel = () => {
    setEditForm(course);
    setIsEditing(false);
  };

  const handleDelete = () => {
    if (window.confirm('√ätes-vous s√ªr de vouloir supprimer ce cours ?')) {
      if (deleteCourse(parseInt(id))) {
        navigate('/');
      }
    }
  };

  const handleProgressUpdate = (updatedCourse) => {
    setCourse(updatedCourse);
    setEditForm(updatedCourse);
  };

  const handleExportPDF = () => {
    generateSingleCoursePDF(course);
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setEditForm(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  // Fonction pour convertir le Markdown en HTML
  const convertMarkdownToHtml = (text) => {
    return text
      // **texte** ‚Üí <strong>texte</strong>
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      // *texte* ‚Üí <em>texte</em>
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      // __texte__ ‚Üí <strong>texte</strong>
      .replace(/__(.*?)__/g, '<strong>$1</strong>')
      // _texte_ ‚Üí <em>texte</em>
      .replace(/_(.*?)_/g, '<em>$1</em>')
      // `code` ‚Üí <code>code</code>
      .replace(/`(.*?)`/g, '<code>$1</code>')
      // # Titre ‚Üí <h1>Titre</h1>
      .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
      // ## Titre ‚Üí <h2>Titre</h2>
      .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
      // ### Titre ‚Üí <h3>Titre</h3>
      .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
      // - item ‚Üí <li>item</li> (liste)
      .replace(/^- (.*?)$/gm, '<li>$1</li>')
      // Remplacer les retours √† la ligne par des <br>
      .replace(/\n/g, '<br>');
  };

  // G√©rer le collage avec conversion Markdown
  const handlePaste = (e) => {
    e.preventDefault();
    
    // R√©cup√©rer le texte coll√©
    const clipboardData = e.clipboardData || window.clipboardData;
    const pastedText = clipboardData.getData('text/plain');
    
    // Convertir le Markdown en HTML
    const htmlContent = convertMarkdownToHtml(pastedText);
    
    // Ins√©rer le contenu HTML dans l'√©diteur
    if (descriptionRef.current) {
      document.execCommand('insertHTML', false, htmlContent);
    }
  };

  // G√©rer la saisie dans l'√©diteur de texte riche
  const handleDescriptionInput = () => {
    if (descriptionRef.current) {
      setEditForm(prev => ({
        ...prev,
        description: descriptionRef.current.innerHTML
      }));
    }
  };

  // Formater le texte s√©lectionn√©
  const formatText = (command) => {
    document.execCommand(command, false, null);
    descriptionRef.current.focus();
  };

  if (!course) {
    return (
      <div className="course-detail">
        <div className="loading">
          <h2>üîÑ Chargement du cours...</h2>
        </div>
      </div>
    );
  }

  return (
    <div className="course-detail">
      <header className="course-detail-header">
        <div className="breadcrumb">
          <Link to="/" className="back-link">
            ‚Üê Retour √† la liste
          </Link>
          <h1>üìö Mes Cours & Cie</h1>
        </div>
      </header>

      <main className="course-detail-main">
        <div className="course-detail-content">
          {isEditing ? (
            <div className="edit-form">
              <div className="form-group">
                <label>Titre du cours *</label>
                <input
                  type="text"
                  name="title"
                  value={editForm.title || ''}
                  onChange={handleInputChange}
                  placeholder="Titre du cours"
                />
              </div>

              <div className="form-group">
                <label>Mati√®re *</label>
                <select
                  name="subject"
                  value={editForm.subject || ''}
                  onChange={handleInputChange}
                >
                  <option value="">S√©lectionner une mati√®re</option>
                  <option value="Informatique">Informatique</option>
                  <option value="Math√©matiques">Math√©matiques</option>
                  <option value="Histoire">Histoire</option>
                  <option value="Chimie">Chimie</option>
                  <option value="Langues">Langues</option>
                  <option value="Physique">Physique</option>
                  <option value="Biologie">Biologie</option>
                  <option value="G√©ographie">G√©ographie</option>
                  <option value="Litt√©rature">Litt√©rature</option>
                  <option value="Philosophie">Philosophie</option>
                  <option value="√âconomie">√âconomie</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>

              <div className="form-group">
                <label>Description *</label>
                
                {/* Info Markdown */}
                <div className="markdown-info">
                  <span className="info-icon">üí°</span>
                  <span className="info-text">
                    Vous pouvez coller du texte Markdown : **gras**, *italique*, `code`, # titre
                  </span>
                </div>
                
                {/* Barre d'outils de formatage */}
                <div className="formatting-toolbar">
                  <button
                    type="button"
                    onClick={() => formatText('bold')}
                    className="format-btn"
                    title="Gras"
                  >
                    <strong>B</strong>
                  </button>
                  <button
                    type="button"
                    onClick={() => formatText('italic')}
                    className="format-btn"
                    title="Italique"
                  >
                    <em>I</em>
                  </button>
                  <button
                    type="button"
                    onClick={() => formatText('underline')}
                    className="format-btn"
                    title="Soulign√©"
                  >
                    <u>U</u>
                  </button>
                  <button
                    type="button"
                    onClick={() => formatText('formatBlock', 'h3')}
                    className="format-btn"
                    title="Titre"
                  >
                    H3
                  </button>
                  <button
                    type="button"
                    onClick={() => formatText('insertUnorderedList')}
                    className="format-btn"
                    title="Liste √† puces"
                  >
                    ‚Ä¢ Liste
                  </button>
                  <button
                    type="button"
                    onClick={() => formatText('insertOrderedList')}
                    className="format-btn"
                    title="Liste num√©rot√©e"
                  >
                    1. Liste
                  </button>
                </div>

                {/* √âditeur de texte riche */}
                <div
                  ref={descriptionRef}
                  contentEditable
                  className="rich-text-editor"
                  onInput={handleDescriptionInput}
                  onPaste={handlePaste}
                  suppressContentEditableWarning={true}
                  placeholder="Description du cours (vous pouvez coller du texte Markdown)"
                />
              </div>

              <div className="form-checkbox">
                <input
                  type="checkbox"
                  name="isFavorite"
                  checked={editForm.isFavorite || false}
                  onChange={handleInputChange}
                />
                <label>‚≠ê Marquer comme favori</label>
              </div>

              <div className="form-actions">
                <button 
                  type="button" 
                  onClick={handleCancel}
                  className="btn-cancel"
                >
                  Annuler
                </button>
                <button 
                  type="button" 
                  onClick={handleSave}
                  className="btn-save"
                >
                  Sauvegarder
                </button>
              </div>
            </div>
          ) : (
            <div className="course-view">
              <div className="course-header">
                <h2>
                  {course.title}
                  {course.isFavorite && <span className="favorite-badge">‚≠ê</span>}
                </h2>
                <div className="course-meta">
                  <span className="course-date">üìÖ {course.createdAt}</span>
                  <span className="course-subject">üè∑Ô∏è {course.subject}</span>
                </div>
              </div>

              <div className="course-content">
                <h3>üìù Description</h3>
                <div 
                  className="course-description"
                  dangerouslySetInnerHTML={{ __html: course.description }}
                />
              </div>

              <ProgressTracker 
                course={course} 
                onUpdate={handleProgressUpdate} 
              />

              <div className="course-actions">
                <button 
                  onClick={handleEdit}
                  className="btn-edit"
                >
                  ‚úèÔ∏è √âditer
                </button>
                <button onClick={handleExportPDF} className="btn-export">
                  üìÑ Exporter en PDF
                </button>
                <button 
                  onClick={handleDelete}
                  className="btn-delete"
                >
                  üóëÔ∏è Supprimer
                </button>
              </div>
            </div>
          )}
        </div>
      </main>
    </div>
  );
};

export default CourseDetail;
